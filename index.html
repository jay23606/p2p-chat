<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width">
    <title>P2P Chat</title>
    <style>
        #message {
            display: flex;
            flex-direction: column-reverse;
            height: 500px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div>
        <span id="self-id" title="Peer gives you their self ID to connect"></span><button id="copy-btn">Copy self-ID</button>
    </div>
    <input id="peer-id" placeholder="self-ID of peer" />
    <button id="connect-btn">Connect</button>
    <span style="float:right">Nick:<input id="nick" /></span>
    <div id="stat"></div>
    <fieldset style="border:1px solid black">
        <legend>Messages</legend>
        <div id="message"></div>
    </fieldset>
    <input type="text" id="send-input" placeholder="Enter message and press enter" style="width:98.5%" />
    <script src="https://unpkg.com/peerjs@1.3.1/dist/peerjs.min.js"></script>
    <script type="text/javascript">
        $ = id => document.getElementById(id)
        let lastPeerId = null, conn = null;
        const peerId = $("peer-id"), selfId = $("self-id"), stat = $("stat"), message = $("message"), sendInput = $("send-input"),
            connectBtn = $("connect-btn"), nick = $("nick"), copyBtn = $("copy-btn");

        const ready = () => {
            conn.on('data', (data) => addMessage(data));
            conn.on('close', () => stat.innerHTML = "Connection reset<br>Awaiting connection...");
        }
        const addMessage = (msg) => message.innerHTML = message.innerHTML + "<br>" + msg

        sendInput.addEventListener('keypress', e => (e.which === 13) ? connSend(sendInput) : '');

        const connSend = (input) => {
            if (conn && conn.open) {
                let msg = `${nick.value||'Anonymous'}: ` + input.value;
                conn.send(msg); addMessage(msg); input.value = '';
            }
        }

        let peer = new Peer(null, { debug: 2 });
        peer.on('open', id => {
            if (peer.id === null) peer.id = lastPeerId;
            else lastPeerId = peer.id;
            selfId.textContent = peer.id;
            console.log('ID: ' + peer.id);
        });

        peer.on('connection', c => {
            conn = c;
            stat.textContent = "Connected";
            ready();
        });

        peer.on('disconnected', () => {
            stat.textContent = "Connection lost. Please reconnect";
            peer.id = lastPeerId;
            peer._lastServerId = lastPeerId;
            peer.reconnect();
        });

        peer.on('close', () => stat.textContent = "Connection destroyed. Please refresh");

        peer.on('error', (err) => stat.textContent = `Error: ${err} `);

        connectBtn.addEventListener('click', (e) => {
            if (conn) conn.close();
            conn = peer.connect(peerId.value, { reliable: true });
            conn.on('open', () => stat.textContent = "Connected to: " + conn.peer);
            conn.on('data', (data) => addMessage(data));
            conn.on('close', () => stat.textContent = "Connection closed");
        });

        const copyText = (el) => {
            let ta = document.createElement("textarea");
            ta.value = el.textContent;
            document.body.appendChild(ta);
            ta.select();
            document.execCommand("copy");
            document.body.removeChild(ta);
        }

        copyBtn.addEventListener('click', () => copyText(selfId))
    </script>
</body>
</html>
