<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Screen Sharing Example</title>
  </head>
  <body>
    <div>
      <label for="session-id">Session ID:</label>
      <input type="text" id="session-id" placeholder="Enter session ID">
      <button id="start-share">Start sharing</button>
    </div>
    <video id="localVideo" autoplay muted></video>
    <video id="remoteVideo" autoplay></video>

    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script>
      const sessionIdInput = document.getElementById('session-id');
      const startShareButton = document.getElementById('start-share');
      const localVideo = document.getElementById('localVideo');
      const remoteVideo = document.getElementById('remoteVideo');
      let peer = null;
      let call = null;

      // Initialize the Peer object
      function init() {
        peer = new Peer();
        peer.on('open', function(id) {
          console.log('My peer ID is: ' + id);
        });
      }

      // Start sharing your screen
      async function startScreenShare(sessionId) {
        try {
          // Use getDisplayMedia() to capture your screen sharing stream
          const stream = await navigator.mediaDevices.getDisplayMedia({ video: true });
          
          // Display your screen sharing stream in the local video element
          localVideo.srcObject = stream;

          // Call the peer with the specified session ID and pass in your screen sharing stream as the local stream
          call = peer.call(sessionId, stream);

          // Handle the stream event to display the peer's stream in the remote video element
          call.on('stream', function(remoteStream) {
            remoteVideo.srcObject = remoteStream;
          });
        } catch (err) {
          console.error('Error starting screen share:', err);
        }
      }

      // Get the session ID from the URL query parameter and connect to the peer
      function connectToPeer(sessionId) {
        peer = new Peer();
        peer.on('open', function(id) {
          console.log('Connected to peer with ID: ' + id);
          call = peer.call(sessionId);
          call.on('stream', function(remoteStream) {
            remoteVideo.srcObject = remoteStream;
          });
        });
      }

      // Check if the current page is the sharing page or the viewing page
      function checkPageType() {
        const params = new URLSearchParams(window.location.search);
        const sessionId = params.get('sessionId');
        if (sessionId) {
          connectToPeer(sessionId);
        } else {
          init();
          startShareButton.addEventListener('click', function() {
            const sessionId = Math.random().toString(36).substring(2, 8);
            window.location.href = window.location.href.split('?')[0] + '?sessionId=' + sessionId;
          });
        }
      }

      checkPageType();
    </script>
  </body>
</html>
